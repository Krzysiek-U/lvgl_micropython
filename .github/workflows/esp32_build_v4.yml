name: Build-LVGL-Final-N16R8
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4

      - name: Install System Deps
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0 python3 python3-pip

      - name: Checkout MicroPython
        uses: actions/checkout@v4
        with:
          repository: micropython/micropython
          ref: v1.22.2
          path: micropython
          submodules: recursive

      - name: Checkout ESP-IDF
        uses: actions/checkout@v4
        with:
          repository: espressif/esp-idf
          ref: v5.0.4
          path: esp-idf
          submodules: recursive

      - name: Checkout LVGL Bindings
        uses: actions/checkout@v4
        with:
          repository: lvgl/lv_binding_micropython
          path: micropython/lib/lv_bindings
          submodules: recursive

      - name: Install-IDF
        run: |
          cd esp-idf
          ./install.sh esp32s3
        shell: bash

      - name: Config-Board (N16R8 + 1.8V + Octal)
        run: |
          BOARD_DIR="micropython/ports/esp32/boards/ESP32_GENERIC_S3"
          
          # 1. Tabela partycji dla 16MB Flash (Factory 6MB, reszta VFS)
          cat <<EOF > ${BOARD_DIR}/partitions.csv
          nvs,      data, nvs,     0x9000,   0x6000,
          otadata,  data, ota,     0xf000,   0x2000,
          phy_init, data, phy,     0x11000,  0x1000,
          factory,  app,  factory, 0x20000,  0x600000,
          vfs,      data, fat,     0x620000, 0x900000,
          EOF
          
          # 2. Konfiguracja sprzętowa (Octal RAM + Flash Voltage)
          cat <<EOF > ${BOARD_DIR}/sdkconfig.board
          CONFIG_SPIRAM=y
          CONFIG_SPIRAM_MODE_OCT=y
          CONFIG_SPIRAM_SPEED_80M=y
          CONFIG_SPIRAM_BOOT_INIT=y
          CONFIG_ESP32S3_FLASH_VOLTAGE_1_8V=y
          CONFIG_ESP32S3_SPIRAM_VOLTAGE_1_8V=y
          CONFIG_ESPTOOLPY_FLASHSIZE_16MB=y
          CONFIG_PARTITION_TABLE_CUSTOM=y
          CONFIG_PARTITION_TABLE_CUSTOM_FILENAME="partitions.csv"
          CONFIG_PARTITION_TABLE_FILENAME="partitions.csv"
          EOF

      - name: Build-All
        run: |
          source esp-idf/export.sh
          
          # 1. Budowa mpy-cross (niezbędny do kompilacji bindingów)
          make -C micropython/mpy-cross
          
          # 2. Przygotowanie LVGL i portu
          cd micropython/ports/esp32
          
          # Kopiujemy konfigurację LVGL do folderu portu
          cp $GITHUB_WORKSPACE/lv_conf.h .
          
          # Kluczowa zmiana: Ścieżka musi prowadzić do FOLDERU, w którym jest micropython.cmake
          # W lv_binding_micropython plik ten znajduje się bezpośrednio w głównym katalogu bindingów
          export LVGL_MODULES="$GITHUB_WORKSPACE/micropython/lib/lv_bindings/micropython.cmake"
          
          # 3. Inicjalizacja submodułów specyficznych dla ESP32
          make BOARD=ESP32_GENERIC_S3 submodules
          
          # 4. Kompilacja przy użyciu Makefile (który sam obsłuży idf.py)
          # Przekazujemy USER_C_MODULES jako absolutną ścieżkę do pliku .cmake
          make BOARD=ESP32_GENERIC_S3 USER_C_MODULES="$LVGL_MODULES"
          
          # 5. Kopiowanie gotowego firmware
          cp build-ESP32_GENERIC_S3/firmware.bin $GITHUB_WORKSPACE/firmware.bin
        shell: bash




      - name: Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-lvgl-n16r8
          path: micropython/ports/esp32/build-ESP32_GENERIC_S3/firmware.bin
