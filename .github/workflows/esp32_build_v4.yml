name: ESP32-S3 MicroPython + LVGL (N16R8 Octal SPI)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-esp32s3-lvgl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0 python3 python3-pip

      - name: Clone MicroPython (v1.22.2)
        run: |
          # Używamy stabilnej wersji v1.22.2, która świetnie działa z LVGL 8.3
          git clone --depth=1 --branch v1.22.2 https://github.com
          cd micropython
          git submodule update --init --recursive lib/berkeley-db-1.85 lib/mbedtls lib/tinyusb

      - name: Clone ESP-IDF (v5.0.4)
        run: |
          # v5.0.4 ma wszystkie sterowniki SPI i LCD "na miejscu" (unikniesz błędu add-dependency)
          git clone -b v5.0.4 --depth=1 --recursive https://github.com
          cd esp-idf
          ./install.sh esp32s3

      - name: Clone LVGL Micropython bindings
        run: |
          # Klonujemy bindings i ich submoduł lvgl
          git clone --recursive https://github.com lib/lv_bindings

      - name: Prepare Board Config (N16R8 Octal + 16MB Flash)
        run: |
          BOARD_DIR="micropython/ports/esp32/boards/ESP32_GENERIC_S3"
          
          # 1. Tworzymy tabelę partycji (4MB App, 11MB VFS)
          cat <<EOF > ${BOARD_DIR}/partitions.csv
          # Name,   Type, SubType, Offset,  Size, Flags
          nvs,      data, nvs,     0x9000,  0x6000,
          otadata,  data, ota,     0xf000,  0x2000,
          phy_init, data, phy,     0x11000, 0x1000,
          factory,  app,  factory, 0x20000, 0x400000,
          vfs,      data, fat,     0x420000, 0xB00000,
          EOF

          # 2. Tworzymy sdkconfig.board wymuszający Octal SPIRAM i 1.8V
          # To rozwiązuje konflikt pinów 6/7 z PSRAM
          cat <<EOF > ${BOARD_DIR}/sdkconfig.board
          CONFIG_SPIRAM=y
          CONFIG_SPIRAM_MODE_OCT=y
          CONFIG_SPIRAM_SPEED_80M=y
          CONFIG_SPIRAM_BOOT_INIT=y
          CONFIG_ESP32S3_FLASH_VOLTAGE_1_8V=y
          CONFIG_ESP32S3_SPIRAM_VOLTAGE_1_8V=y
          CONFIG_ESPTOOLPY_FLASHSIZE_16MB=y
          CONFIG_BOARD_PARTITION_TABLE="partitions.csv"
          EOF

      - name: Build MicroPython + LVGL
        run: |
          source esp-idf/export.sh
          
          # 1. Najpierw mpy-cross
          make -C micropython/mpy-cross
          
          # 2. Port ESP32
          cd micropython/ports/esp32
          make submodules
          
          # 3. Kompilacja z LVGL jako modułem C
          # Zwróć uwagę na ścieżkę do bindings.cmake (względem ports/esp32)
          make BOARD=ESP32_GENERIC_S3 \
               USER_C_MODULES=../../../lib/lv_bindings/bindings.cmake
        shell: bash

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-esp32s3-n16r8-lvgl
          path: micropython/ports/esp32/build-ESP32_GENERIC_S3/firmware.bin
